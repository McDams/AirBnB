---
title: "AirBnB"
format: html
editor: visual
---

## 1. Chargement des librairies

```{r}
library(readr)
library(tidyverse)  # Manipulation et Visualisation
library(lubridate)  
library(skimr)      # Statistique
```

## 2. Importation des donn√©es

## 2.1 Paris

## 2.1.1 Listings

```{r}
listings_paris <- read_csv("../data/paris/listings.csv")
```

## 2.1.2 Affichage des premi√®res lignes

```{r}
head(listings_paris)
```

## 2.1.3 Suppression des doublons

```{r}
listings_paris <- listings_paris %>%
  distinct()
```

## 2.1.4 Statistiques descriptives

```{r}
skim(listings_paris)
```

## 2.2 Bordeaux

## 2.2.1 Listings

```{r}
listings_bordeaux <- read_csv("../data/bordeaux/listings.csv")
```

## 2.2.2 Affichage des premi√®res lignes

```{r}
head(listings_bordeaux)
```

## 2.2.3 Suppression des doublons

```{r}
listings_bordeaux <- listings_bordeaux %>%
  distinct()
```

## 2.2.4 Statistiques descriptives

```{r}
skim(listings_bordeaux)
```

## 2.3 Lyon

## 2.3.1 Listings

```{r}
listings_lyon <- read_csv("../data/lyon/listings.csv")
```

## 2.3.2 Affichage des premi√®res lignes

```{r}
head(listings_lyon)
```

## 2.3.3 Suppression des doublons

```{r}
listings_lyon <- listings_lyon %>%
  distinct()
```

## 2.3.4 Statistiques descriptives

```{r}
skim(listings_lyon)
```

## 3. Nettoyage des donn√©es

## 3.1 Paris

## 3.1.1 Listings - Suppression des colonnes inutiles

```{r}
# Suppression de la colonne licence
listings_paris <- listings_paris %>%
  select(-license)

# Suppression de la colonne neighbourhood_group
listings_paris <- listings_paris %>%
  select(-neighbourhood_group)

# V√©rification
head(listings_paris)
```

## 3.1.2 Listings - Supresion des lignes NA dans la colonne price

```{r}
# Suppression des lignes avec des valeurs NA dans la colonne price
listings_paris <- listings_paris %>%
  filter(!is.na(price))

# V√©rification
head(listings_paris)
```

## 3.2 Bordeaux

## 3.2.1 Listings - Suppression des colonnes inutiles

```{r}
# Suppression de la colonne licence
listings_bordeaux <- listings_bordeaux %>%
  select(-license)

# Suppression de la colonne neighbourhood_group
listings_bordeaux <- listings_bordeaux %>%
  select(-neighbourhood_group)

# V√©rification
head(listings_bordeaux)
```

3.2.2 Listings - Supresion des lignes NA dans la colonne price

```{r}
# Suppression des lignes avec des valeurs NA dans la colonne price
listings_bordeaux <- listings_bordeaux %>%
  filter(!is.na(price))

# V√©rification
head(listings_bordeaux)
```

## 3.3 Lyon

## 3.3.1 Listings - Suppression des colonnes inutiles

```{r}
# Suppression de la colonne licence
listings_lyon <- listings_lyon %>%
  select(-license)

# Suppression de la colonne neighbourhood_group
listings_lyon <- listings_lyon %>%
  select(-neighbourhood_group)

# V√©rification
head(listings_lyon)
```

## 3.3.2 Listings - Supresion des lignes NA dans la colonne price

```{r}
# Suppression des lignes avec des valeurs NA dans la colonne price
listings_lyon <- listings_lyon %>%
  filter(!is.na(price))

# V√©rification
head(listings_lyon)
```

## 4. Sauvegarde des donn√©es nettoy√©es

```{r}
write_csv(listings_paris, "../data_cleaned/paris/listings_cleaned.csv")
write_csv(listings_bordeaux, "../data_cleaned/bordeaux/listings_cleaned.csv")
write_csv(listings_lyon, "../data_cleaned/lyon/listings_cleaned.csv")
```

## 5. Renommer les fichiers nettoy√©s

```{r}
file.rename("../data_cleaned/paris/listings_cleaned.csv", "../data_cleaned/paris/listings_paris_cleaned.csv")
file.rename("../data_cleaned/bordeaux/listings_cleaned.csv", "../data_cleaned/bordeaux/listings_bordeaux_cleaned.csv")
file.rename("../data_cleaned/lyon/listings_cleaned.csv", "../data_cleaned/lyon/listings_lyon_cleaned.csv")
```

```{r}
listings_paris <- read_csv("../data_cleaned/paris/listings_paris_cleaned.csv")
listings_bordeaux <- read_csv("../data_cleaned/bordeaux/listings_bordeaux_cleaned.csv")
listings_lyon <- read_csv("../data_cleaned/lyon/listings_lyon_cleaned.csv")
```

## 6. Analyse exploratoire des donn√©es (EDA)

## 6.1 Nombre total d'annonces par ville

```{r}
total_listings <- tibble(
  City = c("Paris", "Bordeaux", "Lyon"),
  Total_Listings = c(nrow(listings_paris), nrow(listings_bordeaux), nrow(listings_lyon))
)

total_listings
```

## 6.2 Graphe du nombre total d'annonces par ville

```{r}
library(ggplot2)

ggplot(total_listings, aes(x = City, y = Total_Listings, fill = City)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Total_Listings), vjust = -0.5) +
  labs(title = "Nombre total d'annonces par ville", x = "Ville", y = "Nombre total d'annonces") +
  theme_minimal()

ggsave("../figures/total_listings_by_city.png")
```

## 6.3 Prix moyen, median, minimum, max des annonces par ville

## 6.3.1 Convertion de la colonne price en num√©rique et suppression des symboles \$ et , puis conversion en ‚Ç¨

```{r}
convert_price <- function(df) {
  df %>%
    mutate(price = as.numeric(gsub("[$,]", "", price)) * 0.85)  # Suppression des symboles $ et , puis conversion en ‚Ç¨
}

listings_paris <- convert_price(listings_paris)
listings_bordeaux <- convert_price(listings_bordeaux)
listings_lyon <- convert_price(listings_lyon)
```

## 6.3.2 Calcul des statistiques

```{r}
price_stats <- tibble(
  City = c("Paris", "Bordeaux", "Lyon"),
  Mean_Price = c(mean(listings_paris$price, na.rm = TRUE),
                 mean(listings_bordeaux$price, na.rm = TRUE),
                 mean(listings_lyon$price, na.rm = TRUE)),
  Median_Price = c(median(listings_paris$price, na.rm = TRUE),
                   median(listings_bordeaux$price, na.rm = TRUE),
                   median(listings_lyon$price, na.rm = TRUE)),
  Min_Price = c(min(listings_paris$price, na.rm = TRUE),
                min(listings_bordeaux$price, na.rm = TRUE),
                min(listings_lyon$price, na.rm = TRUE)),
  Max_Price = c(max(listings_paris$price, na.rm = TRUE),
                max(listings_bordeaux$price, na.rm = TRUE),
                max(listings_lyon$price, na.rm = TRUE))
)
price_stats

# Sauvegarde des statistiques dans un fichier image
png("../figures/price_statistics_by_city.png", width = 800, height = 600)
gridExtra::grid.table(price_stats)
dev.off()
```

## 6.4 Distribution des prix des annonces par ville (histogramme)

```{r}
ggplot() +
  geom_histogram(data = listings_paris, aes(x = price, fill = "Paris"), alpha = 0.5, bins = 30) +
  geom_histogram(data = listings_bordeaux, aes(x = price, fill = "Bordeaux"), alpha = 0.5, bins = 30) +
  geom_histogram(data = listings_lyon, aes(x = price, fill = "Lyon"), alpha = 0.5, bins = 30) +
  labs(title = "Distribution des prix des annonces par ville", x = "Prix (‚Ç¨)", y = "Nombre d'annonces") +
  scale_fill_manual(name = "Ville", values = c("Paris" = "blue", "Bordeaux" = "red", "Lyon" = "green")) +
  theme_minimal()

ggsave("../figures/price_distribution_by_city.png")
```

## 6.5 Type de logement le plus courant par ville

```{r}
most_common_room_type <- tibble(
  City = c("Paris", "Bordeaux", "Lyon"),
  Most_Common_Room_Type = c(
    listings_paris %>%
      count(room_type) %>%
      arrange(desc(n)) %>%
      slice(1) %>%
      pull(room_type),
    listings_bordeaux %>%
      count(room_type) %>%
      arrange(desc(n)) %>%
      slice(1) %>%
      pull(room_type),
    listings_lyon %>%
      count(room_type) %>%
      arrange(desc(n)) %>%
      slice(1) %>%
      pull(room_type)
  )
)

most_common_room_type

# Sauvegarde des r√©sultats dans un fichier image
png("../figures/most_common_room_type_by_city.png", width = 800, height = 600)
gridExtra::grid.table(most_common_room_type)
dev.off()
```

## =========================

## 7Ô∏è‚É£ H√¥tes üë§ + 8Ô∏è‚É£ Outliers üö® + 9Ô∏è‚É£ ML ü§ñ + üîü Synth√®se

## =========================

```{r}
library(tidyverse)
library(ggplot2)
library(broom)
library(plotly)

## -------------------------------------------------------
## 0) Fusionner les 3 villes dans 1 seul df + colonnes utiles
## -------------------------------------------------------
listings_paris   <- listings_paris   %>% mutate(city = "Paris")
listings_bordeaux<- listings_bordeaux%>% mutate(city = "Bordeaux")
listings_lyon    <- listings_lyon    %>% mutate(city = "Lyon")

listings_all <- bind_rows(listings_paris, listings_bordeaux, listings_lyon)

#colnames(listings_all)

# S√©curiser les types (au cas o√π)
listings_all <- listings_all %>%
  mutate(
  calculated_host_listings_count = as.numeric(calculated_host_listings_count),
  reviews_per_month = as.numeric(reviews_per_month),
  number_of_reviews = as.numeric(number_of_reviews),
  availability_365 = as.numeric(availability_365),
  price = as.numeric(price)
  )

dir.create("../figures", showWarnings = FALSE, recursive = TRUE)
```

## =======================================================

## 7Ô∏è‚É£ H√¥tes üë§

## =======================================================

## 7.1 Bar chart : h√¥tes avec 1 logement vs multi-logements (par ville)

```{r}

hosts_type <- listings_all %>%
filter(!is.na(calculated_host_listings_count)) %>%
mutate(
host_type = if_else(calculated_host_listings_count <= 1,
"1 logement",
"Multi-logements")
) %>%
count(city, host_type) %>%
group_by(city) %>%
mutate(pct = n / sum(n)) %>%
ungroup()

ggplot(hosts_type, aes(x = host_type, y = n, fill = host_type)) +
geom_col() +
geom_text(aes(label = scales::comma(n)), vjust = -0.5, size = 3) +
facet_wrap(~city) +
labs(
title = "H√¥tes : 1 logement vs multi-logements (par ville)",
x = NULL,
y = "Nombre d'annonces"
) +
theme_minimal()

ggsave("../figures/hosts_single_vs_multi_by_city.png", width = 10, height = 5)

```

## 7.2 Scatter : prix vs nombre de logements de l‚Äôh√¥te (par ville)

```{r}
ggplot(
listings_all %>%
filter(!is.na(calculated_host_listings_count), !is.na(price)),
aes(x = calculated_host_listings_count, y = price)
) +
geom_point(alpha = 0.25) +
geom_smooth(method = "lm", se = FALSE) +
facet_wrap(~city, scales = "free_y") +
labs(
title = "Prix vs nombre de logements de l'h√¥te (impact h√¥tes professionnels)",
x = "Nombre de logements du host",
y = "Prix (‚Ç¨)"
) +
theme_minimal()

ggsave("../figures/price_vs_host_listings_scatter_by_city.png",
width = 10, height = 5)

```

## =======================================================

## 8Ô∏è‚É£ Valeurs aberrantes üö®

## =======================================================

## 8.1 Boxplot : prix par ville

```{r}

ggplot(listings_all %>% filter(!is.na(price)), aes(x = city, y = price, fill = city)) +
  geom_boxplot(outlier.alpha = 0.2) +
  labs(title = "Boxplot des prix par ville (d√©tection outliers)", x = NULL, y = "Prix (‚Ç¨)") +
  theme_minimal()

ggsave("../figures/boxplot_price_by_city.png", width = 8, height = 5)
```

## 8.2 D√©finir un nettoyage simple des outliers (IQR par ville)

```{r}

remove_outliers_iqr <- function(df, col = price) {
  x <- df %>% pull({{col}})
  q1 <- quantile(x, 0.25, na.rm = TRUE)
  q3 <- quantile(x, 0.75, na.rm = TRUE)
  iqr <- q3 - q1
  low <- q1 - 1.5 * iqr
  high <- q3 + 1.5 * iqr
  df %>% filter({{col}} >= low, {{col}} <= high)
}

listings_all_clean <- listings_all %>%
  filter(!is.na(price)) %>%
  group_by(city) %>%
  group_modify(~ remove_outliers_iqr(.x, price)) %>%
  ungroup()

```

## 8.3 Histogramme AVANT / APR√àS (facett√© par ville)

```{r}


before_after <- bind_rows(
  listings_all %>% filter(!is.na(price)) %>% mutate(stage = "Avant"),
  listings_all_clean %>% mutate(stage = "Apr√®s")
)

ggplot(before_after, aes(x = price)) +
  geom_histogram(bins = 40, alpha = 0.6) +
  facet_grid(stage ~ city, scales = "free_y") +
  labs(title = "Distribution des prix : avant / apr√®s nettoyage outliers (IQR)", x = "Prix (‚Ç¨)", y = "Nombre") +
  theme_minimal()

ggsave("../figures/hist_price_before_after_outliers.png", width = 12, height = 6)

```

## =======================================================

## 9Ô∏è‚É£ Machine Learning ‚Äì Pr√©diction du prix ü§ñ

## =======================================================

## 9.0 S√©lection features + gestion NA

```{r}


```

## 9.1 Entra√Æner un mod√®le par ville (comparaison R¬≤ + pr√©dictions)

```{r}

ml_df <- listings_all_clean %>%
select(
city,
price,
calculated_host_listings_count,
number_of_reviews,
number_of_reviews_ltm,
reviews_per_month,
availability_365,
room_type
) %>%
mutate(
calculated_host_listings_count = as.numeric(calculated_host_listings_count),
number_of_reviews = as.numeric(number_of_reviews),
number_of_reviews_ltm = as.numeric(number_of_reviews_ltm),
availability_365 = as.numeric(availability_365),
reviews_per_month = if_else(
is.na(reviews_per_month),
mean(reviews_per_month, na.rm = TRUE),
reviews_per_month
),
room_type = as.factor(room_type)
) %>%
drop_na(price, calculated_host_listings_count, availability_365)


```

## 9.2 Tableau R¬≤ comparatif

```{r}
ggplot(ml_df, aes(x = availability_365, y = price)) +
geom_point(alpha = 0.25) +
geom_smooth(method = "lm", se = FALSE) +
facet_wrap(~city, scales = "free_y") +
labs(
title = "R√©gression lin√©aire simple : Prix ~ Disponibilit√© (availability_365)",
x = "Disponibilit√© sur 365 jours",
y = "Prix (‚Ç¨)"
) +
theme_minimal()


```

## 9.3 Scatter : prix r√©el vs prix pr√©dit (par ville) - mod√®le multiple

```{r}

set.seed(42)

models <- ml_df %>%
group_by(city) %>%
group_map(~{
idx <- sample(seq_len(nrow(.x)), size = floor(0.8 * nrow(.x)))
train <- .x[idx, ]
test <- .x[-idx, ]

model <- lm(
  price ~ calculated_host_listings_count +
    number_of_reviews +
    number_of_reviews_ltm +
    reviews_per_month +
    availability_365 +
    room_type,
  data = train
)

pred <- predict(model, newdata = test)

tibble(
  city = unique(.x$city),
  r2 = cor(test$price, pred, use = "complete.obs")^2,
  price_real = test$price,
  price_pred = pred
)

}) %>%
bind_rows()

models

```

## 9.4 Droite de r√©gression (r√©gression simple) : price \~ accommodates

```{r}

ggplot(ml_df, aes(x = availability_365, y = price)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~city, scales = "free_y") +
  labs(
    title = "R√©gression lin√©aire simple : Prix ~ Disponibilit√© (par ville)",
    x = "Disponibilit√© sur 365 jours (availability_365)",
    y = "Prix (‚Ç¨)"
  ) +
  theme_minimal()

ggsave("../figures/regression_simple_by_city.png",
       width = 10, height = 5)

```


## 9.5 Graphique 3D (r√©gression multiple) ‚Äî exemple avec 3 variables

```{r}
## On prend un √©chantillon pour √©viter trop de points
set.seed(42)

ml_sample <- ml_df %>%
group_by(city) %>%
group_modify(~{
k <- min(800, nrow(.x))
dplyr::slice_sample(.x, n = k)
}) %>%
ungroup()

p3d <- plot_ly(
ml_sample,
x = ~availability_365,
y = ~reviews_per_month,
z = ~price,
color = ~city,
type = "scatter3d",
mode = "markers",
marker = list(size = 2, opacity = 0.5)
) %>%
layout(
title = "3D : Prix vs Disponibilit√© vs Activit√© (par ville)",
scene = list(
xaxis = list(title = "availability_365"),
yaxis = list(title = "reviews_per_month"),
zaxis = list(title = "price (‚Ç¨)")
)
)

p3d

```


## =======================================================

## üîü Graphiques de synth√®se (top soutenance)

## =======================================================

## 10.1 Top 10 types de logements les plus chers (par ville) ‚Äî property_type

```{r}
top_neighbourhood <- listings_all_clean %>%
filter(!is.na(neighbourhood), !is.na(price)) %>%
group_by(city, neighbourhood) %>%
summarise(
mean_price = mean(price, na.rm = TRUE),
n = n(),
.groups = "drop"
) %>%
filter(n >= 30) %>% # √©vite les quartiers trop rares
group_by(city) %>%
slice_max(mean_price, n = 10) %>%
ungroup()

ggplot(top_neighbourhood,
aes(x = reorder(neighbourhood, mean_price), y = mean_price)) +
geom_col() +
coord_flip() +
facet_wrap(~city, scales = "free") +
labs(
title = "Top 10 quartiers (neighbourhood) les plus chers par ville",
x = NULL,
y = "Prix moyen (‚Ç¨)"
) +
theme_minimal()

```

## 10.2 Comparaison prix moyen / note moyenne par ville

```{r}
ggplot(ml_df, aes(x = reviews_per_month, y = price, color = city)) +
geom_point(alpha = 0.15) +
geom_smooth(method = "lm", se = FALSE) +
labs(
title = "Impact de l'activit√© (reviews_per_month) sur le prix ‚Äî 3 villes",
x = "Avis par mois (reviews_per_month)",
y = "Prix (‚Ç¨)"
) +
theme_minimal()


```

## 10.3 Impact capacit√© ‚Üí prix (3 courbes sur un m√™me graphe)

```{r}
ggplot(ml_df, aes(x = availability_365, y = price, color = city)) + 
  geom_point(alpha = 0.15) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Impact de la disponibilit√© (availability_365) sur le prix ‚Äî comparaison 3 villes",
    x = "Disponibilit√© sur 365 jours",
    y = "Prix (‚Ç¨)"
  ) +
  theme_minimal()

ggsave("../figures/impact_availability_price_3cities.png",
       width = 10, height = 5)
```
